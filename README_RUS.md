UNIVERSAL WRAPPER PIPELINE SETTINGS
===================================

Набор конфигураций для 
[universal wrapper pipeline](https://github.com/alexanderbazhenoff/jenkins-universal-wrapper-pipeline). Для ознакомления
с функционалом pipeline'а можно перейти по
[этой](https://github.com/alexanderbazhenoff/jenkins-universal-wrapper-pipeline) ссылке, ниже будет представлено 
подробное описание непосредственно самого формата
[конфигурационных файлов](https://github.com/alexanderbazhenoff/jenkins-universal-wrapper-pipeline). 

Конфигурационный файл Universal Wrapper Pipeline должен соответствовать всем
[стандартам yaml-синтаксиса](https://yaml.org/). На каждый wrapper pipeline - один файл (но возможны исключения, при
которых с помощью [регулярных выражений](#пример-1) один конфигурационный файл может конфигурировать несколько копий
wrapper pipeline'ов c разными именами).

# Имена конфигурационных файлов

Файл конфигурации с именем `имя-пайлайна.yaml` и по умолчанию располагаться внутри репозитория по пути `settings/` 
(можно задать константой pipeline'а `PipelineNameRegexReplace`). В имени pipeline'а допускаются всевозможные префиксы и
постфиксы, а для их удаления и приведения к соответствию к имени конфигурационного файла есть константа pipeline'а 
`PipelineNameRegexReplace`, содержащая список регулярных выражений, совпадения из которого будут удалены из имени 
pipeline'а при формировании имени конфигурационного файла.

#### Пример 1

Константа в pipeline имеет следующее значение:
```groovy
final PipelineNameRegexReplace = ['^(admin|devops|qa)_'] as ArrayList
```
Следовательно, pipeline'ы с именами:
`admin_example-pipeline`, `devops_example-pipeline` и `qa_example-pipeline` будут ссылаться на один и тот же
конфигурационный файл `example-pipeline.yaml`.

*Регулярные выражения и задание пути внутри репозитория предназначены исключительно для упрощения структуризации
конфигурационных файлов внутри репозитория. Можно оставить путь по умолчанию, а список регулярных выражений - пустым,
тогда конфигурационные файлы будут располагаться: `settings/admin_example-pipeline.yaml`,
`settings/devops_example-pipeline.yaml` и `settings/qa_example-pipeline.yaml` соответственно.*

# Основные ключи конфигурационных файлов

- [**parameters**](#ключ-parameters) `[словарь]` *(обязательный, если pipeline параметризованный)* - параметры pipeline.
- [**stages**](#ключ-stages) `[словарь]` *(обязательный)* - стадии pipeline, содержащие список действий, каждый из
  которых ссылается на уникальное в рамках pipeline название действия (action name) из ключа [actions](#ключ-actioins).
- [**actions**](#actions) `[словарь]` *(обязательный)* - описание действий, которые так же могут ссылаться на playbook
  и inventory из ключей [playbooks](#ключ-playbooks) и [inventories](#ключ-inventories), или на скрипт из ключа
[scripts](#ключ-scripts).
- [**scripts**](#ключ-scripts) `[словарь]` *(необязательный)* - ключ, содержащий скрипты, которые будут запущены при
  выполнении соответствующего action'а.
- [**playbooks**](#ключ-playbooks) `[словарь]` *(необязательный)* - ключ, содержащий ansible playbooks, которые будут
  запущены при выполнении соответствующего action'а.
- [**inventories**](#ключ-inventories) `[словарь]` *(необязательный)* - ключ, содержащий ansible playbooks, которые
  будут запущены при выполнении соответствующего action'а. При наличии ключа playbooks наличие 
  [ключа inventories](#ключ-inventories) и хотя бы одного inventory с именем `default` является обязательным.  

## Ключ parameters

Параметры pipeline делятся на три типа:

  - [**required**](#required) `[список]` - обязательные параметры, без указания которых текущий запуск pipeline
    завершится c ошибкой. Можно так же настроить, чтобы вместо ошибки выводилось предупреждение, или подставлялось
    значение из другого параметра.
  - [**optional**](#optional) `[список]` - опциональные параметры, которые можно указывать по мере необходимости.
  - **built-in** - "встроенные" параметры: `SETTINGS_GIT_BRANCH`, `NODE_NAME`, `NODE_TAG`, `UPDATE_PARAMETERS`,
    `DRY_RUN`, `DEBUG_MODE`. Эти параметры уже встроены непосредственно в код pipeline (константа 
    `BuiltinPipelineParameters`), задавать их в файле конфигурации не нужно.
  
Если хотя бы один из приведенных в конфигурационном файле параметров pipeline отсутствует в параметрах pipeline в его
настройках, то все параметры pipeline будут заново синхронизированы с параметрами в конфигурационном файле. Сравнение
производится только по именам параметров, тип, значения по умолчанию и другие ключи параметров игнорируются.

Pipeline может не иметь обязательных параметров (ключ [required](#required)) и все параметры могут быть размещены в
[optional](#optional). Так же любой обязательный параметр может стать необязательным и наоборот без перемещения его
в соответствующий словарь (required/optional) за-счет указания дополнительных опций ключа [`on_empty`](#required) (см.
[Пример 2](#пример-2)). Pipeline может так же иметь только необязательные параметры (см. [Пример 4](#пример-4)), или
вовсе их не иметь (непараметризировання сборка).

### Required

Ключ [required](#required) находится внутри ключа [parameters](#ключ-parameters) и состоит из списка параметров pipeline
каждый из которых имеет следующие ключи:

- **name** `[строка]` *(обязательный)* - имя параметра pipeline.
- **type** `[строка]` *(обязательный)* - тип параметра, который полностью соответствует типам параметров для jenkins
  pipeline. Варианты: `string` (строковый), `text` (многострочный), `password`, `choice`, `boolean`. Указание типа 
  параметра pipeline является обязательным, хотя в некоторых случаях возможно автоопределение типа с выводом
  соответствующего предупреждения.
- **description** `[строка]` *(необязательный)* - описание параметра pipeline.
- **default** [зависит от `type`] *(необязателен и не совместим с типом параметра choice)* - значение
  параметра pipeline по умолчанию. Если не указан, то значение параметра pipeline по умолчанию будет `false` для 
  *boolean* и пустое поле для строковых (в том числе password) параметров.
- **choices** `[список]` *(совместим только с типом параметров choice)* - опции выбора для choice-параметров. Параметры
  без опций выбора (choices не указан, или пуст) допустимы.
- **trim** `[boolean]` *(совместим только с типом параметров string, но необязателен)* - удалять начальные и конечные
  пробелы в строковом значении параметра. По умолчанию для строк: `false`.
- **on_empty** `[словарь]` *(необязательный)* - опции для управления действий, если параметр при запуске pipeline не 
  указан (пустой) [Пример 2](#пример-2). Содержит следующие вложенные ключи:
    - **assign** `[строка]` *(необязательный)* - имя параметра pipeline'а, значение которого будет присвоено, если
      параметр не указан (пуст). Возможно так же присвоение переменных окружения, а следовательно, переменных Jenkins:
      `NODE_NAME`, `JOB_NAME` и т.д.
    - **fail** `[boolean]` *(необязательный, не совместим с ключом warn)* - завершить pipeline с ошибкой, если параметр
      pipeline не указан.
    - **warn** `[boolean]` *(необязательный, не совместим с ключом fail)* - вывести предупреждение, но продолжить
      выполнение pipeline'а, если параметр не указан.

  Если параметр pipeline находится внутри [required](#required) и ключ `on_empty` не указан, то по умолчанию пустой
  обязательный параметр завершит pipeline с ошибкой. Таким образом, обязательность параметра можно отменить без
  перемещения его в [optional](#optional).
- **regex** `[строка, или список]` *(необязательный)* - регулярное выражение, или список строк регулярного выражения,
  которые будут объеденины в единую строку для проверки параметра pipeline: если значения параметра не попадает под
  регулярное выражение, текущий запуск pipeline будет остановлен с ошибкой.
- **regex_replace** `[словарь]` *(необязательный)* - опции для управления заменой значений параметров pipeline, которые
  будут произведены при подстановке параметров pipeline'а. Допустим только для строковых (за исключением password)
  параметров. Содержит следующие вложенные ключи:
    - **regex** `[строка]` *(обязательный)* - регулярное значение для поиска заменяемого содержимого параметра.
    - **to** `[строка]` *(необязательный)* - заменить совпадения на указанное в данном ключе содержимое (см. 
      [Пример 3](#пример-3)). Если значение или сам ключ `to` не указан, то все совпадения регулярного выражения в ключе
     `regex` будут удалены.

#### Пример 2

Pipeline содержит три параметра в [ключе required](#required), но только параметр `LOGIN` является обязательным, пропуск
которого завершит выполннение pipeline ошибкой. Если параметры `PASSWORD` не указан, то в консоли появится только
предупреждение и pipeline продолжит выполннение, а если не указан `LOGIN_2`, то будет выдано предупреждение, а значение
будет взято из параметра pipeline'а `LOGIN`.

```yaml
parameters:
  required:
    - name: LOGIN
      type: string
    - name: LOGIN_2
      type: string
      on_empty:
        assign: $LOGIN
        warn: True
    - name: PASSWORD
      type: password
      on_empty:
        warn: True
```

#### Пример 3

Обязательный параметр pipline'а `IP_ADDRESSES`, где в списке пробелы будут заменены на "перевод строки" для подстановки
в ansible inventory:

```yaml
parameters:
  required:
    - name: IP_ADDRESSES
      type: string
      description: Space separated IP or DNS list of the host(s) to perform PIPELINE_ACTION and ROLE_SUBJECT.
      regex_replace:
        regex: ' '
        to: \n
```

### Optional

Ключ [optional](#optional) находится внутри ключа [parameters](#ключ-parameters) и состоит из списка необязательных
параметров pipeline. Структура и список ключей аналогична ключу [required](#required) за исключением того, что задавать
здесь значения ключа `on_empty` не нужно, так как они будут проигнорированы.

#### Пример 4

Pipeline содержит только необязательные параметры `ONE` и `TWO`:

```yaml
parameters:
  optional:
    - name: ONE
      type: string
      description: Description of parameter ONE which type is string and default value is 'something'.
      default: something
    - name: ONE
      type: choice
      description: |
        Description of parameter TWO which type is choices.
        TWO parameters includes three choices ('one', 'two' and 'three')
      choices:
        - one
        - two
        - three 
```
